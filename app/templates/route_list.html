{% extends "base.html" %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Мои маршруты</h2>
        <a href="{{ url_for('create_or_edit_route_info') }}" class="btn btn-success">
            <i class="fas fa-plus"></i> Создать новый маршрут
        </a>
    </div>

    {% if not routes %}
        <div class="alert alert-info" role="alert">
            У вас пока нет сохраненных маршрутов. Начните с создания первого!
        </div>
    {% else %}
        <!--<form method="POST" action="{{ url_for('route_list') }}" id="bulk-generate-form">-->
        <div>
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle">
                    <thead>
                        <tr>
                            <th scope="col" >
                                <!-- empty -->
                            </th>
                            <th scope="col">№</th>
                            <th scope="col">Название маршрута</th>
                            <th scope="col">Перевозчик (ID)</th>
                            <th scope="col">Тип транспорта</th>
                            <th scope="col">Остановки</th>
                            <th scope="col">Тарифы</th>
                            <th scope="col">Статус</th> 
                            <th scope="col" class="text-center" style="min-width: 250px;">Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for route in routes %}
                            <tr>
                                <td>
                                    <!-- empty -->
                                </td>
                                <th scope="row">{{ loop.index }}</th>
                                <td>
                                    <strong>{{ route.route_name }}</strong>
                                </td>
                                <td>{{ route.carrier_id }}</td>
                                <td>
                                    {{ TRANSPORT_TYPES.get(route.transport_type, route.transport_type) }}
                                </td>
                                <td class="text-center">
                                    {{ route.stops | length if route.stops else 0 }}
                                </td>
                                <td class="text-center">
                                    {{ route.tariffs | length if route.tariffs else 0 }}
                                </td>
                                <td>
                                    {% if route.is_completed %}
                                        <span class="badge bg-success" data-bs-toggle="tooltip" title="Маршрут полностью заполнен и готов к экспорту.">Готов</span>
                                    {% else %}
                                        <span class="badge bg-warning text-dark" data-bs-toggle="tooltip" title="Требуется заполнение или проверка данных (Остановки, Цены).">В работе</span>
                                    {% endif %}
                                </td>
                                <td class="d-flex justify-content-center align-items-center"> 

                                    {# Кнопки действий #}

                                    <a href="{{ url_for('create_or_edit_route_info', route_id=route.id) }}" 
                                       class="btn btn-sm btn-success me-2" 
                                       data-bs-toggle="tooltip" title="Редактировать информацию">
                                        <i class="fas fa-edit"></i> Инфо
                                    </a>
                                    
                                    {% if route.stops_set %}
                                        <span data-bs-toggle="tooltip" title="Редактировать остановки">
                                            <a href="{{ url_for('edit_route_stops', route_id=route.id) }}" 
                                            class="btn btn-sm btn-success me-2">
                                                <i class="fas fa-map-marker-alt"></i> Остановки
                                            </a>
                                        </span>
                                    {% else %}
                                        <span data-bs-toggle="tooltip" title="Редактировать остановки">
                                            <a href="{{ url_for('edit_route_stops', route_id=route.id) }}" 
                                            class="btn btn-sm btn-outline-success me-2">
                                                <i class="fas fa-map-marker-alt"></i> Остановки
                                            </a>
                                        </span>
                                    {% endif %}

                                    {% if route.stops_set %}
                                        {% if route.is_completed %}
                                            <span data-bs-toggle="tooltip" title="Редактировать матрицу цен">
                                                <a href="{{ url_for('edit_route_prices', route_id=route.id) }}" 
                                                class="btn btn-sm btn-success me-2">
                                                    <i class="fas fa-dollar-sign"></i> Цены
                                                </a>
                                            </span>
                                        {% else %}
                                            <span data-bs-toggle="tooltip" title="Редактировать матрицу цен">
                                                <a href="{{ url_for('edit_route_prices', route_id=route.id) }}" 
                                                class="btn btn-sm btn-outline-success me-2">
                                                    <i class="fas fa-dollar-sign"></i> Цены
                                                </a>
                                            </span>
                                        {% endif %}
                                    {% else %}
                                        <span data-bs-toggle="tooltip" title="Сначала укажите остановки!">
                                            <a href="#" class="btn btn-sm btn-outline-success me-2 disabled" style="pointer-events: none;">
                                                <i class="fas fa-dollar-sign"></i> Цены
                                            </a>
                                        </span>
                                    {% endif %}
                                    
                                    <button type="button" 
                                            class="btn btn-sm btn-danger" 
                                            data-bs-toggle="tooltip" title="Удалить маршрут"
                                            onclick="confirmDelete('{{ route.id }}', '{{ route.route_name }}');">
                                        <i class="fas fa-trash"></i> Удалить
                                    </button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <!--</form>-->
        {# КОНЕЦ ФОРМЫ ДЛЯ МАССОВОЙ ГЕНЕРАЦИИ #}

        {# Скрытая форма для удаления #}
        <form id="delete-route-form" method="POST" action="">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        </form>
    {% endif %}

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // Инициализация всплывающих подсказок Bootstrap
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    })

    // "Выбрать все" и счетчик
    document.addEventListener('DOMContentLoaded', function() {
        const selectAll = document.getElementById('select-all');
        const checkboxes = document.querySelectorAll('.route-checkbox');
        const countDisplay = document.getElementById('selected-count-display');
        const bulkBtn = document.getElementById('bulk-generate-btn');
        const totalCheckboxes = checkboxes.length;

        function updateCount() {
            let checkedCount = 0;
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    checkedCount++;
                }
            });
            
            // 1. Обновление отображения и состояния кнопки
            countDisplay.textContent = `Выбрано: ${checkedCount}`;
            bulkBtn.disabled = checkedCount === 0; 

            // 2. Синхронизация главного чекбокса
            if (checkedCount === totalCheckboxes && totalCheckboxes > 0) {
                selectAll.checked = true;
                selectAll.indeterminate = false;
            } else if (checkedCount > 0) {
                // Если выбрана часть
                selectAll.checked = false;
                selectAll.indeterminate = true;
            } else {
                // Если не выбран ни один
                selectAll.checked = false;
                selectAll.indeterminate = false;
            }
        }

        // Обработчик "Выбрать все"
        selectAll.addEventListener('change', function() {
            const isChecked = this.checked;
            checkboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
            });
            updateCount(); 
        });

        // Обработчики индивидуальных чекбоксов
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateCount); 
        });

        // Первоначальное обновление счетчика
        updateCount();
    });

    function confirmDelete(routeId, routeName) {
        if (confirm('Вы уверены, что хотите удалить маршрут "' + routeName + '"? Это действие необратимо.')) {
            const form = document.getElementById('delete-route-form');
            // Динамически меняем action формы на нужный URL
            form.action = "{{ url_for('delete_route', route_id=0) }}".replace('0', routeId);
            form.submit();
        }
    }
</script>
{% endblock %}
