{% extends "base.html" %}

{% block content %}
    <h2>{{ title }}</h2>
    
    <form method="POST" id="route-info-form">
        {{ form.hidden_tag() }}

        <h3>1. –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ñ–∞–π–ª–∞)</h3>
        <div class="row">
            <div class="col-md-3 mb-3">
                {{ form.region_code.label(class="form-label") }}
                {{ form.region_code(class="form-control") }}
                {% for error in form.region_code.errors %}<span class="text-danger">{{ error }}</span>{% endfor %}
            </div>
            <div class="col-md-3 mb-3">
                {{ form.carrier_id.label(class="form-label") }}
                {{ form.carrier_id(class="form-control") }}
                {% for error in form.carrier_id.errors %}<span class="text-danger">{{ error }}</span>{% endfor %}
            </div>
            <div class="col-md-3 mb-3">
                {{ form.unit_id.label(class="form-label") }}
                {{ form.unit_id(class="form-control") }}
                {% for error in form.unit_id.errors %}<span class="text-danger">{{ error }}</span>{% endfor %}
            </div>
            <div class="col-md-3 mb-3">
                {{ form.decimal_places.label(class="form-label") }}
                {{ form.decimal_places(class="form-select") }}
                {% for error in form.decimal_places.errors %}<span class="text-danger">{{ error }}</span>{% endfor %}
            </div>
        </div>
        
        <hr>

        <h3>2. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –º–∞—Ä—à—Ä—É—Ç–∞ (–°—Ç—Ä–æ–∫–∞ R)</h3>
        <div class="row">
            <div class="col-md-6 mb-3">
                {{ form.route_name.label(class="form-label") }}
                {{ form.route_name(class="form-control") }}
                {% for error in form.route_name.errors %}<span class="text-danger">{{ error }}</span>{% endfor %}
            </div>
            <div class="col-md-3 mb-3">
                {{ form.route_number.label(class="form-label") }}
                {{ form.route_number(class="form-control") }}
                {% for error in form.route_number.errors %}<span class="text-danger">{{ error }}</span>{% endfor %}
            </div>
            <div class="col-md-3 mb-3">
                {{ form.transport_type.label(class="form-label") }}
                {{ form.transport_type(class="form-select") }}
                {% for error in form.transport_type.errors %}<span class="text-danger">{{ error }}</span>{% endfor %}
            </div>
        </div>

        <hr>

        <h3>3. –¢–∞—Ä–∏—Ñ–Ω—ã–µ –¢–∞–±–ª–∏—Ü—ã (–°—Ç—Ä–æ–∫–∏ Tabs)</h3>
        <p class="text-muted small">
            –ö–∞–∂–¥–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ –≤ –±–ª–æ–∫–µ Tabs. –ú–∞–∫—Å–∏–º—É–º 15 —Ç–∞–±–ª–∏—Ü. <br>
            <b>–¢–∞–±–ª–∏—Ü–∞ 1:</b> –ö–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å <b>02</b>, —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ —Å–µ—Ä–∏–∏ SU –∏ EP. <br>
            <b>–û—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã:</b> –ö–æ–¥ <b>P</b>, <b>T</b> –∏–ª–∏ <b>F</b>, —Å–æ–¥–µ—Ä–∂–∞—Ç —Å–µ—Ä–∏–∏ –ø—Ä–æ–µ–∑–¥–Ω—ã—Ö.
        </p>

        <div id="tariff-tables-container">
            {# –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç–∞—Ä–∏—Ñ–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü #}
            {# üí• –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ò–¢–ï–†–ê–¶–ò–Ø –ü–û form.tariff_tables #}
            {% for entry_form in form.tariff_tables %}
                <div class="card mb-3 tariff-table-entry" data-index="{{ loop.index0 }}">
                    <div class="card-body">
                        <h5 class="card-title">–¢–∞–±–ª–∏—Ü–∞ {{ loop.index }}</h5> 
                        
                        {# üí• –ò–ó–ú–ï–ù–ï–ù–ò–ï: –û–ë–ù–û–í–õ–ï–ù–ù–´–ï –ü–û–õ–Ø –í –°–û–û–¢–í–ï–¢–°–¢–í–ò–ò –° TariffTableEntryForm #}
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ entry_form.form.tariff_name.label(class="form-label") }}
                                {{ entry_form.form.tariff_name(class="form-control", placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞ (–¥–ª—è –º–∞—Ç—Ä–∏—Ü—ã —Ü–µ–Ω)") }}
                                {% for error in entry_form.form.tariff_name.errors %}<span class="text-danger">{{ error }}</span>{% endfor %}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ entry_form.form.table_type_code.label(class="form-label") }}
                                {{ entry_form.form.table_type_code(class="form-control table-type-code", placeholder="02, P, T –∏–ª–∏ F") }}
                                {% for error in entry_form.form.table_type_code.errors %}<span class="text-danger">{{ error }}</span>{% endfor %}
                            </div>
                        </div>

                        <div class="mb-3">
                            {{ entry_form.form.ss_series_codes.label(class="form-label") }}
                            {{ entry_form.form.ss_series_codes(class="form-control ss-codes-input", placeholder="–ö–æ–¥—ã —Å–µ—Ä–∏–π SS —á–µ—Ä–µ–∑ ';', –Ω–∞–ø—Ä. 15;20;58") }}
                            {% for error in entry_form.form.ss_series_codes.errors %}<span class="text-danger">{{ error }}</span>{% endfor %}
                        </div>
                        
                        {# –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è (–±—É–¥–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å—Å—è JS) #}
                        <button type="button" class="btn btn-sm btn-outline-danger remove-tariff-table" onclick="removeTariffTableEntry(this)">–£–¥–∞–ª–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É</button>
                        
                        {# –°–∫—Ä—ã—Ç—ã–π —Ç–æ–∫–µ–Ω CSRF –¥–ª—è –ø–æ–¥—Ñ–æ—Ä–º—ã #}
                        {{ entry_form.form.hidden_tag() }} 
                    </div>
                </div>
            {% endfor %}
        </div>
        
        <button type="button" class="btn btn-sm btn-outline-primary mb-4" onclick="addTariffTableEntry()">
            + –î–æ–±–∞–≤–∏—Ç—å —Ç–∞—Ä–∏—Ñ–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
        </button>

        <div class="mt-4">
            {{ form.next_step(class="btn btn-primary") }}
        </div>
    </form>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // 1. –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ CSRF, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ –≤ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –ø–æ–ª—è—Ö.
    // –≠—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –±–µ—Ä–µ—Ç—Å—è –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ form.hidden_tag(), –∫–æ—Ç–æ—Ä—ã–π –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –Ω–∞—á–∞–ª–µ —Ñ–æ—Ä–º—ã.
    const csrf_token_value = document.querySelector('input[name="csrf_token"]').value;

    // üí• –®–ê–ë–õ–û–ù –î–õ–Ø –ù–û–í–û–ô –¢–ê–†–ò–§–ù–û–ô –¢–ê–ë–õ–ò–¶–´
    const tariffTableTemplate = `
        <div class="card mb-3 tariff-table-entry">
            <div class="card-body">
                <h5 class="card-title">–¢–∞–±–ª–∏—Ü–∞ NEW_INDEX</h5>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞</label>
                        <input type="text" name="tariff_tables-NEW_INDEX-tariff_name" class="form-control" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞ (–¥–ª—è –º–∞—Ç—Ä–∏—Ü—ã —Ü–µ–Ω)" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">–¢–∏–ø/–ö–æ–¥ –¢–∞–±–ª–∏—Ü—ã (02/P/T/F)</label>
                        <input type="text" name="tariff_tables-NEW_INDEX-table_type_code" class="form-control table-type-code" placeholder="02, P, T –∏–ª–∏ F" required>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">–ö–æ–¥—ã —Å–µ—Ä–∏–π SS (—á–µ—Ä–µ–∑ ";")</label>
                    <input type="text" name="tariff_tables-NEW_INDEX-ss_series_codes" class="form-control ss-codes-input" placeholder="–ö–æ–¥—ã —Å–µ—Ä–∏–π SS —á–µ—Ä–µ–∑ ';', –Ω–∞–ø—Ä. 15;20;58" required>
                </div>
                
                <button type="button" class="btn btn-sm btn-outline-danger remove-tariff-table" onclick="removeTariffTableEntry(this)">–£–¥–∞–ª–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É</button>
                
                {# –°–∫—Ä—ã—Ç—ã–π —Ç–æ–∫–µ–Ω CSRF —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∏–º–µ–Ω–µ–º –∏ –∑–Ω–∞—á–µ–Ω–∏–µ–º –¥–ª—è –ø–æ–¥—Ñ–æ—Ä–º—ã #}
                <input type="hidden" name="tariff_tables-NEW_INDEX-csrf_token" value="${csrf_token_value}" />
            </div>
        </div>
    `;

    /**
     * –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤–æ–µ –ø–æ–ª–µ –¥–ª—è –≤–≤–æ–¥–∞ —Ç–∞—Ä–∏—Ñ–∞.
     */
    function addTariffTableEntry() {
        const container = document.getElementById('tariff-tables-container');
        const count = container.querySelectorAll('.tariff-table-entry').length;
        
        // üí• –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –≤ 15 —Ç–∞–±–ª–∏—Ü
        if (count >= 15) {
            alert("–î–æ—Å—Ç–∏–≥–Ω—É—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ª–∏–º–∏—Ç: 15 —Ç–∞—Ä–∏—Ñ–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü.");
            return;
        }

        let newHtml = tariffTableTemplate.replace(/NEW_INDEX/g, count);
        container.insertAdjacentHTML('beforeend', newHtml);
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª–µ–π –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
        updateTariffTableHeaders(); 
    }

    /**
     * –£–¥–∞–ª—è–µ—Ç –ø–æ–ª–µ —Ç–∞—Ä–∏—Ñ–∞ –∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∏–Ω–¥–µ–∫—Å—ã.
     * –≠–¢–û–¢ –§–£–ù–ö–¶–ò–û–ù–ê–õ –ò–°–ü–†–ê–í–õ–ï–ù
     */
    function removeTariffTableEntry(button) {
        const container = document.getElementById('tariff-tables-container');
        const entry = button.closest('.tariff-table-entry');
        
        const entries = container.querySelectorAll('.tariff-table-entry');
        const index = Array.from(entries).indexOf(entry);
        
        // üí• –ó–∞–ø—Ä–µ—Ç –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ –¢–∞–±–ª–∏—Ü—ã 1
        if (index === 0) {
            alert("–¢–∞–±–ª–∏—Ü—É 1 —É–¥–∞–ª–∏—Ç—å –Ω–µ–ª—å–∑—è. –ú–∞—Ä—à—Ä—É—Ç –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Ç–∞–±–ª–∏—Ü—É.");
            return;
        }

        if (entry) {
            entry.remove();
            
            // –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –®–ê–ì: –ü–µ—Ä–µ—Å—á–µ—Ç –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è Flask-WTF
            container.querySelectorAll('.tariff-table-entry').forEach((entry, idx) => {
                // 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞
                entry.querySelector('h5.card-title').textContent = '–¢–∞–±–ª–∏—Ü–∞ ' + (idx + 1);
                
                // 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞—Ç—Ä–∏–±—É—Ç–æ–≤ name —É –∏–Ω–ø—É—Ç–æ–≤
                entry.querySelectorAll('input, select, textarea').forEach(input => {
                    if (input.name) {
                        // –ó–∞–º–µ–Ω—è–µ–º —Å—Ç–∞—Ä—ã–π –∏–Ω–¥–µ–∫—Å –Ω–∞ –Ω–æ–≤—ã–π (tariff_tables-N-field_name)
                        input.name = input.name.replace(/tariff_tables-\d+-/, `tariff_tables-${idx}-`);
                    }
                });
            });

            updateTariffTableHeaders(); // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–æ–∫ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        }
    }
    
    /**
     * –û–±–Ω–æ–≤–ª—è–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç read-only –¥–ª—è –¢–∞–±–ª–∏—Ü—ã 1 –∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç –∫–Ω–æ–ø–∫–∞–º–∏ —É–¥–∞–ª–µ–Ω–∏—è.
     */
    function updateTariffTableHeaders() {
        const container = document.getElementById('tariff-tables-container');
        container.querySelectorAll('.tariff-table-entry').forEach((entry, index) => {
            const title = entry.querySelector('h5.card-title');
            const removeButton = entry.querySelector('.remove-tariff-table');
            const typeCodeInput = entry.querySelector('.table-type-code');

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            title.textContent = '–¢–∞–±–ª–∏—Ü–∞ ' + (index + 1);
            
            if (index === 0) {
                // –¢–∞–±–ª–∏—Ü–∞ 1: –ö–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å "02", –∫–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–∫—Ä—ã—Ç–∞
                if (typeCodeInput) {
                    typeCodeInput.value = '02'; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º "02"
                    typeCodeInput.setAttribute('readonly', true);
                }
                if (removeButton) removeButton.style.display = 'none';
            } else {
                // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã: –ú–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ —É–¥–∞–ª—è—Ç—å
                if (typeCodeInput) {
                    typeCodeInput.removeAttribute('readonly');
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º "02", –µ—Å–ª–∏ –ø–æ–ª–µ –±—ã–ª–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –∏–∑ –ø–µ—Ä–≤–æ–π —Ç–∞–±–ª–∏—Ü—ã
                    if (typeCodeInput.value === '02') typeCodeInput.value = ''; 
                }
                if (removeButton) removeButton.style.display = 'inline-block'; 
            }
        });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.onload = function() {
        // üí• –ù–∞–º –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª–µ–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ, 
        // —á—Ç–æ–±—ã –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ "–¢–∞–±–ª–∏—Ü—ã 1" –∫ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º Jinja-–ø–æ–ª—è–º.
        updateTariffTableHeaders();
    };

    // --- –ö–û–î –î–õ–Ø –ü–†–ï–î–û–¢–í–†–ê–©–ï–ù–ò–Ø –î–í–û–ô–ù–û–ì–û –ù–ê–ñ–ê–¢–ò–Ø ---
    document.getElementById('route-info-form').addEventListener('submit', function() {
        const submitButton = document.querySelector('button[type="submit"]'); 
        if (submitButton) {
            submitButton.disabled = true;
            submitButton.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
        }
    });

</script>
{% endblock %}
