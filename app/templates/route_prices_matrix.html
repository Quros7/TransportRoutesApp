{% extends "base.html" %}

{% block content %}
    <h2>{{ title }}</h2>
    <p>–ú–∞—Ä—à—Ä—É—Ç: <strong>{{ route.route_name }}</strong></p>
    
    <div class="alert alert-info">
        –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ü–µ–Ω—ã –¥–ª—è –ø—Ä–æ–µ–∑–¥–∞ –∏–∑ –Ω–∞—á–∞–ª—å–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (—Å—Ç—Ä–æ–∫–∞) –¥–æ –∫–æ–Ω–µ—á–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (—Å—Ç–æ–ª–±–µ—Ü) –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∞—Ä–∏—Ñ–∞.
        <br>
        <strong>–í–Ω–∏–º–∞–Ω–∏–µ:</strong> –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤–µ—Ä—Ö–Ω–∏–π —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫ (–ø—Ä—è–º–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ).
    </div>

    <form method="POST" id="price-matrix-form">
        {{ form.hidden_tag() }}
        
        {# –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ, –∫—É–¥–∞ JavaScript –ø–æ–º–µ—Å—Ç–∏—Ç –≤—Å—é –º–∞—Ç—Ä–∏—Ü—É –≤ –≤–∏–¥–µ JSON #}
        {{ form.price_matrix_data(id='price-matrix-data') }}

        <div class="table-responsive">
            <table class="table table-bordered table-sm price-matrix">
                <thead>
                    <tr>
                        <th class="align-top text-center" style="min-width: 120px;">–û—Ç / –î–æ</th>
                        {% for stop in route.stops %}
                            {# –ò—Å–∫–ª—é—á–∞–µ–º –ø–µ—Ä–≤—É—é –∫–æ–ª–æ–Ω–∫—É –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è (–ø–æ—Å–∫–æ–ª—å–∫—É i < j) #}
                            {% if loop.index > 0 %} 
                                <th class="text-center">{{ stop.name }}</th>
                            {% endif %}
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {# i - –ò–Ω–¥–µ–∫—Å –Ω–∞—á–∞–ª—å–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (—Å—Ç—Ä–æ–∫–∞) #}
                    {% for start_stop in route.stops %}
                        {# üí• –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω–¥–µ–∫—Å i –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é i –¥–æ –≤–ª–æ–∂–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ #}
                        {% set i = loop.index0 %}
                        
                        {# –ò—Å–∫–ª—é—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –æ—Å—Ç–∞–Ω–æ–≤–∫—É –∫–∞–∫ –Ω–∞—á–∞–ª—å–Ω—É—é —Ç–æ—á–∫—É #}
                        {% if not loop.last %}
                            <tr>
                                <th scope="row" class="table-light">–û—Ç: {{ start_stop.name }} ({{ loop.index0 }})</th>
                                
                                {# j - –ò–Ω–¥–µ–∫—Å –∫–æ–Ω–µ—á–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (—Å—Ç–æ–ª–±–µ—Ü) #}
                                {% for end_stop in route.stops %}
                                    {# {% set i = loop.parent.index0 %} #}
                                    {% set j = loop.index0 %}
                                    
                                    {# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ j > i (–¥–≤–∏–∂–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –≤–ø–µ—Ä–µ–¥) #}
                                    {% if j > i %}
                                        {# –Ø—á–µ–π–∫–∞ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è (i -> j) #}
                                        <td data-start-index="{{ i }}" data-end-index="{{ j }}">
                                            {% for tariff in route.tariffs %}
                                                <div class="tariff-input-group mb-1">
                                                    <label class="small text-muted mb-0">
                                                        {{ tariff.name }}:
                                                    </label>
                                                    <input 
                                                        type="number" 
                                                        step="0.01" 
                                                        min="0"
                                                        class="form-control form-control-sm price-input"
                                                        data-tariff-id="{{ tariff.id }}"
                                                        
                                                        {# –ó–∞–≥—Ä—É–∑–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö #}
                                                        {# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ü–µ–Ω–∞ –≤ –º–∞—Ç—Ä–∏—Ü–µ (matrix[i][j]) #}
                                                        {% set prices = route.price_matrix[i][j] if route.price_matrix and route.price_matrix[i] is defined and route.price_matrix[i][j] is defined else {} %}
                                                        value="{{ prices[tariff.id|string] if tariff.id|string in prices else '' }}"
                                                        
                                                        placeholder="–¶–µ–Ω–∞"
                                                    >
                                                </div>
                                            {% endfor %}
                                        </td>
                                    {% else %}
                                        {# –Ø—á–µ–π–∫–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è (j <= i) #}
                                        <td class="bg-light"></td>
                                    {% endif %}
                                {% endfor %}
                            </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="mt-4">
            {# –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è JS-—Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–±–∏—Ä–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–æ—Ä–º—É #}
            {{ form.save_prices(class="btn btn-success", onclick="collectMatrixData()") }}
            <a href="{{ url_for('route_list') }}" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</a>
        </div>
    </form>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    /**
     * –°–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–π –º–∞—Ç—Ä–∏—Ü—ã —Ü–µ–Ω, —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç JSON-—Å—Ç—Ä—É–∫—Ç—É—Ä—É
     * –∏ –ø–æ–º–µ—â–∞–µ—Ç –µ–µ –≤ —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ 'price-matrix-data' –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Ñ–æ—Ä–º—ã.
     */
    function collectMatrixData() {
        const stopsCount = {{ route.stops | length }};
        
        // --- DEBUG 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫ ---
        console.log('DEBUG (JS): –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫ (stopsCount):', stopsCount);

        // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—É—Å—Ç–æ–π –º–∞—Ç—Ä–∏—Ü—ã (stopsCount x stopsCount)
        // –í—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 'null'
        let matrix = [];
        for (let i = 0; i < stopsCount; i++) {
            // –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ —Å –ø—É—Å—Ç—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ (null)
            matrix[i] = new Array(stopsCount).fill(null);
        }

        // 2. –ò—Ç–µ—Ä–∏—Ä—É–µ–º—Å—è –ø–æ –≤—Å–µ–º —è—á–µ–π–∫–∞–º —Ç–∞–±–ª–∏—Ü—ã, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–¥–µ—Ä–∂–∞—Ç –ø–æ–ª—è –≤–≤–æ–¥–∞
        const cells = document.querySelectorAll('.price-matrix td[data-start-index]');
        
        // --- DEBUG 2: –ü—Ä–æ–≤–µ—Ä–∫–∞, —Å–∫–æ–ª—å–∫–æ —è—á–µ–µ–∫ –Ω–∞–π–¥–µ–Ω–æ ---
        console.log('DEBUG (JS): –ù–∞–π–¥–µ–Ω–æ —è—á–µ–µ–∫ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏:', cells.length);

        cells.forEach(cell => {
            // –ü–æ–ª—É—á–∞–µ–º –∏–Ω–¥–µ–∫—Å—ã (i - —Å—Ç—Ä–æ–∫–∞, j - —Å—Ç–æ–ª–±–µ—Ü)
            const i = parseInt(cell.getAttribute('data-start-index'));
            const j = parseInt(cell.getAttribute('data-end-index'));
            
            let priceData = {};
            let hasPrice = false;

            // 3. –î–ª—è –∫–∞–∂–¥–æ–π —è—á–µ–π–∫–∏ —Å–æ–±–∏—Ä–∞–µ–º —Ü–µ–Ω—ã –ø–æ –≤—Å–µ–º —Ç–∞—Ä–∏—Ñ–∞–º
            const inputs = cell.querySelectorAll('.price-input');
            inputs.forEach(input => {
                const tariffId = input.getAttribute('data-tariff-id');
                let value = input.value.trim();
                
                let numericValue = null;

                if (value !== '' && !isNaN(parseFloat(value))) {
                    numericValue = parseFloat(parseFloat(value).toFixed(2)); // –û–∫—Ä—É–≥–ª—è–µ–º –¥–æ 2 –∑–Ω–∞–∫–æ–≤
                    if (numericValue > 0) {
                        hasPrice = true;
                    }
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ü–µ–Ω—É. –í —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–æ–ø—É—Å–∫,
                // –Ω–æ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –Ω–∞—à–µ–π –º–∞—Ç—Ä–∏—Ü–µ –ª—É—á—à–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å 0,
                // –µ—Å–ª–∏ –ø–æ–ª–µ –±—ã–ª–æ –ø—É—Å—Ç—ã–º, –Ω–æ —è—á–µ–π–∫–∞ –¥–æ–ª–∂–Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å.
                // –ï—Å–ª–∏ –Ω–µ—Ç —Ü–µ–Ω—ã, —Å—Ç–∞–≤–∏–º 0.
                priceData[tariffId] = numericValue || 0; 
            });

            // 4. –ü–æ–º–µ—â–∞–µ–º —Å–ª–æ–≤–∞—Ä—å —Ü–µ–Ω –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ –º–µ—Å—Ç–æ –≤ –º–∞—Ç—Ä–∏—Ü–µ
            // –ú—ã —Å–æ—Ö—Ä–∞–Ω—è–µ–º —è—á–µ–π–∫—É, –¥–∞–∂–µ –µ—Å–ª–∏ –≤—Å–µ —Ü–µ–Ω—ã 0, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É.
            matrix[i][j] = priceData;

            // --- DEBUG 3: –õ–æ–≥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞–∂–¥–æ–π –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ–π —è—á–µ–π–∫–∏ ---
            // if (hasPrice) { 
            //     console.log(`–Ø—á–µ–π–∫–∞ [${i}][${j}] —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞:`, priceData);
            // }
            // –ú—ã –±—É–¥–µ–º –ø–æ–ª–∞–≥–∞—Ç—å—Å—è –Ω–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ JSON
        });

        // --- DEBUG 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Ç–æ–≥–æ–≤–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –ø–µ—Ä–µ–¥ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π ---
        console.log('DEBUG (JS): –ò—Ç–æ–≥–æ–≤–∞—è –º–∞—Ç—Ä–∏—Ü–∞ (–æ–±—ä–µ–∫—Ç JS):', matrix);

        // 5. –°–µ—Ä–∏–∞–ª–∏–∑—É–µ–º –≥–æ—Ç–æ–≤—É—é –º–∞—Ç—Ä–∏—Ü—É –≤ JSON-—Å—Ç—Ä–æ–∫—É
        const matrixJsonString = JSON.stringify(matrix);
        
        // --- DEBUG 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Ç–æ–≥–æ–≤–æ–π JSON-—Å—Ç—Ä–æ–∫–∏ ---
        console.log('DEBUG (JS): –ò—Ç–æ–≥–æ–≤–∞—è JSON-—Å—Ç—Ä–æ–∫–∞:', matrixJsonString);

        // 6. –ü–æ–º–µ—â–∞–µ–º JSON-—Å—Ç—Ä–æ–∫—É –≤ —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ —Ñ–æ—Ä–º—ã
        document.getElementById('price-matrix-data').value = matrixJsonString;
        
        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –ø–æ–ª–µ –Ω–µ –ø—É—Å—Ç–æ–µ, —á—Ç–æ–±—ã –ø—Ä–æ–π—Ç–∏ –≤–∞–ª–∏–¥–∞—Ç–æ—Ä DataRequired
        // –í–∞–ª–∏–¥–Ω—ã–π JSON –¥–ª—è –ø—É—Å—Ç–æ–π –º–∞—Ç—Ä–∏—Ü—ã: [[{}, {}, ...], ...] -> –î–ª–∏–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞.
        if (matrixJsonString.length > 5) {
            console.log('DEBUG (JS): JSON-—Å—Ç—Ä–æ–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–∏—Å–∞–Ω–∞ –∏ –≤–∞–ª–∏–¥–Ω–∞. –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã.');
            return true; // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É
        } else {
            // –≠—Ç–æ—Ç –±–ª–æ–∫ –Ω–µ –¥–æ–ª–∂–µ–Ω —Å—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å, –µ—Å–ª–∏ stopsCount > 1
            console.error("DEBUG (JS): –û—à–∏–±–∫–∞: JSON-—Å—Ç—Ä–æ–∫–∞ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∞—è (–º–µ–Ω–µ–µ 5 —Å–∏–º–≤–æ–ª–æ–≤). –í–µ—Ä–æ—è—Ç–Ω–æ, –º–∞—Ç—Ä–∏—Ü–∞ –ø—É—Å—Ç–∞.");
            alert("–ú–∞—Ç—Ä–∏—Ü–∞ —Ü–µ–Ω –ø—É—Å—Ç–∞ –∏–ª–∏ –Ω–µ –±—ã–ª–∞ —Å–æ–±—Ä–∞–Ω–∞.");
            return false;
        }
    }
</script>
{% endblock %}
