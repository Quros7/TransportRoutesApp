{% extends "base.html" %}

{% block content %}
    <h2>{{ title }}</h2>
    <p>–ú–∞—Ä—à—Ä—É—Ç: <strong>{{ route.route_name }}</strong></p>
    
    <div class="alert alert-info">
        –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ü–µ–Ω—ã –¥–ª—è –ø—Ä–æ–µ–∑–¥–∞ –∏–∑ –Ω–∞—á–∞–ª—å–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (—Å—Ç—Ä–æ–∫–∞) –¥–æ –∫–æ–Ω–µ—á–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (—Å—Ç–æ–ª–±–µ—Ü) –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∞—Ä–∏—Ñ–∞.
        <br>
        <strong>–í–Ω–∏–º–∞–Ω–∏–µ:</strong> –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤–µ—Ä—Ö–Ω–∏–π —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫ (–ø—Ä—è–º–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ).
    </div>

    <form method="POST" id="price-matrix-form">
        {{ form.csrf_token }}
        {# –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ, –∫—É–¥–∞ JavaScript –ø–æ–º–µ—Å—Ç–∏—Ç –≤—Å—é –º–∞—Ç—Ä–∏—Ü—É –≤ –≤–∏–¥–µ JSON #}
        {{ form.price_matrix_data(id='price-matrix-data') }}
        
        {# –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ, –∫—É–¥–∞ JavaScript –ø–æ–º–µ—Å—Ç–∏—Ç –≤—Å—é –º–∞—Ç—Ä–∏—Ü—É –≤ –≤–∏–¥–µ JSON #}
        {# {{ form.price_matrix_data(id='price-matrix-data') }} #}

        <div class="table-responsive">
            <table class="table table-bordered table-sm price-matrix">
                <thead>
                    <tr>
                        <th class="align-top text-center" style="min-width: 120px;">–û—Ç / –î–æ</th>
                        {% set is_city_route = route.transport_type == '0x02' %}
                        {% for stop in route.stops %}
                            {# –†–∞–∑—Ä–µ—à–∞–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –¥–ª—è –û—Å—Ç–∞–Ω–æ–≤–∫–∏ 0 (–∏–Ω–¥–µ–∫—Å 0), –µ—Å–ª–∏ —ç—Ç–æ –≥–æ—Ä–æ–¥—Å–∫–æ–π –º–∞—Ä—à—Ä—É—Ç. #}
                            {% if loop.index > 0 or is_city_route %} 
                                <th class="text-center">{{ stop.name }} ({{ loop.index0 }})</th>
                            {% endif %}
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {# i - –ò–Ω–¥–µ–∫—Å –Ω–∞—á–∞–ª—å–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (—Å—Ç—Ä–æ–∫–∞) #}
                    {% for start_stop in route.stops %}
                        {# –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω–¥–µ–∫—Å i –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é i –¥–æ –≤–ª–æ–∂–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ #}
                        {% set i = loop.index0 %}
                        
                        {# –†–∞–∑—Ä–µ—à–∞–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏, –µ—Å–ª–∏ –º–∞—Ä—à—Ä—É—Ç –≥–æ—Ä–æ–¥—Å–∫–æ–π (0x02), –¥–∞–∂–µ –µ—Å–ª–∏ —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω—è—è (–∏ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è) –æ—Å—Ç–∞–Ω–æ–≤–∫–∞. #}
                        {% set is_city_route = route.transport_type == '0x02' %}
                        {% if not loop.last or (is_city_route and loop.last) %}
                            <tr>
                                <th scope="row" class="table-light">–û—Ç: {{ start_stop.name }} ({{ loop.index0 }})</th>
                                
                                {# j - –ò–Ω–¥–µ–∫—Å –∫–æ–Ω–µ—á–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (—Å—Ç–æ–ª–±–µ—Ü) #}
                                {% for end_stop in route.stops %}
                                    {# {% set i = loop.parent.index0 %} #}
                                    {% set j = loop.index0 %}
                                    
                                    {# –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–∏–π –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —è—á–µ–π–∫–∏ #}
                                    {% set allow_input = (j > i) or (is_city_route and i == j) %}

                                    {% if allow_input %}
                                        {# –Ø—á–µ–π–∫–∞ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è #}
                                        <td data-start-index="{{ i }}" data-end-index="{{ j }}">
                                            {% for tariff_table in route.tariff_tables %}
                                                {% set tariff_id = tariff_table.tab_number %} {# –ò—Å–ø–æ–ª—å–∑—É–µ–º TabN –∫–∞–∫ ID (1, 2, 3...) #}
                                                
                                                <div class="tariff-input-group mb-1">
                                                    <label class="small text-muted mb-0">
                                                        {{ tariff_table.tariff_name }}:
                                                    </label>
                                                    <input 
                                                        type="number" 
                                                        step="0.01" 
                                                        min="0"
                                                        class="form-control form-control-sm price-input"
                                                        data-tariff-id="{{ tariff_id }}"
                                                        
                                                        {# –ó–∞–≥—Ä—É–∑–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö #}
                                                        {# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ü–µ–Ω–∞ –≤ –º–∞—Ç—Ä–∏—Ü–µ (matrix[i][j]) #}
                                                        {% set prices = route.price_matrix[i][j] if route.price_matrix and route.price_matrix[i] is defined and route.price_matrix[i][j] is defined else {} %}
                                                        value="{{ prices[tariff_id|string] if tariff_id|string in prices else '' }}"
                                                        
                                                        placeholder="–¶–µ–Ω–∞"
                                                    >
                                                </div>
                                            {% endfor %}
                                        </td>
                                    {% else %}
                                        {# –Ø—á–µ–π–∫–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è (j <= i) #}
                                        <td class="bg-light" data-start-index="{{ i }}" data-end-index="{{ j }}">
                                            {# üí• –î–ª—è –¥–∏–∞–≥–æ–Ω–∞–ª–∏ (i==j) –Ω–µ-–≥–æ—Ä–æ–¥—Å–∫–∏—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–º–µ—Ç–∫—É #}
                                            {% if i == j and not is_city_route %}
                                                <span class="text-muted small">–í–Ω—É—Ç—Ä–∏–∑–æ–Ω–æ–≤–∞—è</span>
                                            {% endif %}
                                        </td>
                                    {% endif %}
                                {% endfor %}
                            </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {# –ö–Ω–æ–ø–∫–∏ –ù–∞–∑–∞–¥ –∏ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å #}
        <div class="mt-4 d-flex justify-content-between">
            <a href="{{ url_for('edit_route_stops', route_id=route.id) }}" class="btn btn-outline-secondary">
                <i class="bi bi-chevron-left"></i> –ù–∞–∑–∞–¥ (–û—Å—Ç–∞–Ω–æ–≤–∫–∏)
            </a>
            
            <button type="button" id="save-prices-btn" class="btn btn-success" onclick="collectMatrixData(event)">
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ü–µ–Ω—ã
            </button>
        </div>
    </form>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const inputs = document.querySelectorAll('.price-input');
        const mainTable = document.querySelector('.price-matrix'); 

        inputs.forEach(input => {
            input.addEventListener('focus', function() {
                const td = this.closest('td');
                const tr = td.closest('tr'); 

                // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —ç—Ç–∏ –¥–≤–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
                const curI = parseInt(td.getAttribute('data-start-index'));
                const curJ = parseInt(td.getAttribute('data-end-index'));

                // 1. –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –°–¢–†–û–ö–£ (–æ—Ç –Ω–∞—á–∞–ª–∞ –¥–æ —Ç–µ–∫—É—â–µ–π —è—á–µ–π–∫–∏)
                tr.querySelectorAll('td[data-end-index]').forEach(el => {
                    const jVal = parseInt(el.getAttribute('data-end-index'));
                    if (jVal <= curJ) {
                        el.classList.add('table-row-highlight');
                    }
                });

                // 2. –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –°–¢–û–õ–ë–ï–¶ (–æ—Ç –≤–µ—Ä—Ö–∞ –¥–æ —Ç–µ–∫—É—â–µ–π —è—á–µ–π–∫–∏)
                mainTable.querySelectorAll(`td[data-end-index="${curJ}"]`).forEach(el => {
                    const iVal = parseInt(el.getAttribute('data-start-index'));
                    if (iVal <= curI) {
                        el.classList.add('table-col-highlight');
                    }
                });

                // 3. –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
                // –°—Ç—Ä–æ–∫–∞
                const rowHeader = tr.querySelector('th[scope="row"]');
                if (rowHeader) rowHeader.classList.add('table-active-header');

                // –ö–æ–ª–æ–Ω–∫–∞ (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –∏—Å–ø–æ–ª—å–∑—É–µ–º mainTable –≤–º–µ—Å—Ç–æ table)
                const colHeader = mainTable.querySelector(`thead th:nth-child(${curJ + 2})`);
                if (colHeader) colHeader.classList.add('table-active-header');
                
                // –°–∞–º–∞ –∞–∫—Ç–∏–≤–Ω–∞—è —è—á–µ–π–∫–∞
                td.classList.add('table-active-cell');
            });

            input.addEventListener('blur', function() {
                if (mainTable) {
                    mainTable.querySelectorAll('.table-row-highlight, .table-col-highlight, .table-active-header, .table-active-cell')
                        .forEach(el => {
                            el.classList.remove('table-row-highlight', 'table-col-highlight', 'table-active-header', 'table-active-cell');
                        });
                }
            });
        });
    });

    /**
     * –í–∞—à–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
     */
    function collectMatrixData(event) {
        if (event) event.preventDefault();
        const stopsCount = {{ route.stops | length }};
        let matrix = [];
        for (let i = 0; i < stopsCount; i++) {
            matrix[i] = new Array(stopsCount).fill(null);
        }
        const cells = document.querySelectorAll('.price-matrix td[data-start-index]');
        cells.forEach(cell => {
            const i = parseInt(cell.getAttribute('data-start-index'));
            const j = parseInt(cell.getAttribute('data-end-index'));
            let priceData = {};
            const inputs = cell.querySelectorAll('.price-input');
            inputs.forEach(input => {
                const tariffId = input.getAttribute('data-tariff-id');
                let value = input.value.trim();
                let numericValue = null;
                if (value !== '' && !isNaN(parseFloat(value))) {
                    numericValue = parseFloat(parseFloat(value).toFixed(2));
                }
                priceData[tariffId] = numericValue || 0;
            });
            matrix[i][j] = priceData;
        });
        document.getElementById('price-matrix-data').value = JSON.stringify(matrix);
        document.getElementById('price-matrix-form').submit();
        return false;
    }
</script>
{% endblock %}
