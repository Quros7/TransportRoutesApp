from flask_wtf import FlaskForm
from wtforms import StringField, PasswordField, BooleanField, SubmitField, FieldList, FormField, DecimalField, SelectField, HiddenField
from wtforms.validators import ValidationError, DataRequired, Email, EqualTo, Length, Regexp, InputRequired, NumberRange
from decimal import Decimal, InvalidOperation
import sqlalchemy as sa
from app import db
from app.models import User


class LoginForm(FlaskForm):
    username = StringField('–õ–æ–≥–∏–Ω', validators=[DataRequired()])
    password = PasswordField('–ü–∞—Ä–æ–ª—å', validators=[DataRequired()])
    remember_me = BooleanField('–ó–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è')
    submit = SubmitField('–í–æ–π—Ç–∏')


class RegistrationForm(FlaskForm):
    username = StringField('–õ–æ–≥–∏–Ω', validators=[DataRequired()])
    email = StringField('Email', validators=[DataRequired(), Email()])
    password = PasswordField('–ü–∞—Ä–æ–ª—å', validators=[DataRequired()])
    password2 = PasswordField(
        '–ü–æ–≤—Ç–æ—Ä –ø–∞—Ä–æ–ª—è', validators=[DataRequired(), EqualTo('password')])
    submit = SubmitField('–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è')

    def validate_username(self, username):
        user = db.session.scalar(sa.select(User).where(
            User.username == username.data))
        if user is not None:
            raise ValidationError('–≠—Ç–æ –∏–º—è —É–∂–µ –∑–∞–Ω—è—Ç–æ.')

    def validate_email(self, email):
        user = db.session.scalar(sa.select(User).where(
            User.email == email.data))
        if user is not None:
            raise ValidationError('–≠—Ç–æ—Ç email –∞–¥—Ä–µ—Å —É–∂–µ –∑–∞–Ω—è—Ç.')


# --- –ü–æ–¥—Ñ–æ—Ä–º–∞ –¥–ª—è –≤–≤–æ–¥–∞ –æ–¥–Ω–æ–π –¢–∞—Ä–∏—Ñ–Ω–æ–π –¢–∞–±–ª–∏—Ü—ã (–°—Ç—Ä–æ–∫–∞ Tabs) ---
class TariffTableEntryForm(FlaskForm):
    # 1. –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞ (–¥–ª—è –®–∞–≥–∞ 3 –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è)
    tariff_name = StringField('–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞', validators=[DataRequired(), Length(max=50)])

    # 2. –¢–∏–ø —Ç–∞–±–ª–∏—Ü—ã (–°—Ç–∞—Ä—Ç–æ–≤—ã–π –∫–æ–¥)
    # 02 –¥–ª—è –ø–µ—Ä–≤–æ–π —Ç–∞–±–ª–∏—Ü—ã, P/T/F –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö.
    # –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º StringField –∏ Regexp –¥–ª—è —Å—Ç—Ä–æ–≥–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è, –ø–æ—Å–∫–æ–ª—å–∫—É —ç—Ç–æ –ª–∏–±–æ '02', –ª–∏–±–æ 'P', 'T', 'F'.
    table_type_code = StringField('–¢–∏–ø/–ö–æ–¥ –¢–∞–±–ª–∏—Ü—ã (02/P/T/F)', validators=[
        DataRequired(),
        Length(min=1, max=2),
        Regexp(r'^(02|[PTF])$', 
               message='–î–æ–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ "02" (–¥–ª—è –ø–µ—Ä–≤–æ–π —Ç–∞–±–ª–∏—Ü—ã), "P", "T" –∏–ª–∏ "F".')
    ])
    
    # 3. –°–µ—Ä–∏–∏ SS (—Å–ø–∏—Å–æ–∫ –∫–æ–¥–æ–≤)
    # –í–∫–ª—é—á–∞–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏—é, —á—Ç–æ —ç—Ç–æ —Å–ø–∏—Å–æ–∫ —á–∏—Å–µ–ª, —Ä–∞–∑–¥–µ–ª–µ–Ω–Ω—ã—Ö ';'.
    ss_series_codes = StringField('–ö–æ–¥—ã —Å–µ—Ä–∏–π SS (—á–µ—Ä–µ–∑ ";")', validators=[
        DataRequired(),
        # –ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ï –†–ï–ì–£–õ–Ø–†–ù–û–ï –í–´–†–ê–ñ–ï–ù–ò–ï
        Regexp(r'^(\d{2}|[A-Z])(;(\d{2}|[A-Z]))*$', 
               message='–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥—ã —Å–µ—Ä–∏–π SS —á–µ—Ä–µ–∑ ";". –ö–∞–∂–¥–∞—è —Å–µ—Ä–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å 2-–∑–Ω–∞—á–Ω—ã–º —á–∏—Å–ª–æ–º (–∏–ª–∏ –±—É–∫–≤–µ–Ω–Ω—ã–º –∫–æ–¥–æ–º).')
    ])


# --- –ü–æ–¥—Ñ–æ—Ä–º–∞ –¥–ª—è –≤–≤–æ–¥–∞ –æ–¥–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ ---
class StopForm(FlaskForm):
    stop_name = StringField('–ù–∞–∑–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏', validators=[DataRequired(), Length(max=19)])
    # –î–æ–±–∞–≤–∏–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ñ–∞–π–ª–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    # km_distance = DecimalField('–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ (–∫–º –æ—Ç –Ω–∞—á–∞–ª—å–Ω–æ–π —Ç–æ—á–∫–∏)', places=2, validators=[DataRequired()], default=0.00)

    # –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ (–ú–æ–∂–µ—Ç –±—ã—Ç—å 0.00, –Ω–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ)
    km_distance = DecimalField(
        '–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –∑–æ–Ω—ã (–∫–º)', 
        places=2,
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º InputRequired, —á—Ç–æ–±—ã —Ä–∞–∑—Ä–µ—à–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ 0
        validators=[InputRequired(), NumberRange(min=0, message="–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º.")]
    )


    def validate_km_distance(self, field):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç —á–∏—Å–ª–∞ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ 99.99."""
        
        value = field.data

        # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ Null/None (—É–∂–µ —Å–¥–µ–ª–∞–Ω–∞ InputRequired, –Ω–æ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏)
        if value is None:
            return

        # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ Decimal –∏–º–µ–µ—Ç —Ä–æ–≤–Ω–æ –¥–≤–∞ –∑–Ω–∞–∫–∞ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π (places=2 —É–∂–µ –ø–æ–º–æ–≥–∞–µ—Ç, –Ω–æ –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç)
        if value.as_tuple().exponent != -2:
            # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–∫—Ä—É–≥–ª—è–µ–º –¥–æ 2 –∑–Ω–∞–∫–æ–≤, –µ—Å–ª–∏ DecimalField –Ω–µ —Å–ø—Ä–∞–≤–∏–ª—Å—è,
            # –∏ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å –∏—Å—Ö–æ–¥–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º.
            # –ù–∞–ø—Ä–∏–º–µ—Ä: 5.40001 –æ–∫—Ä—É–≥–ª–∏—Ç—Å—è –¥–æ 5.40. –ï—Å–ª–∏ –æ–Ω–∏ –Ω–µ —Ä–∞–≤–Ω—ã, —Ç–æ –æ—à–∏–±–∫–∞.
            if value != value.quantize(Decimal('0.00')):
                raise ValidationError(
                    '–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –∏–º–µ—Ç—å –Ω–µ –±–æ–ª–µ–µ –¥–≤—É—Ö –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π (–§–æ—Ä–º–∞—Ç 99.99).'
                )
        
        # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (99.99)
        if value > Decimal('99.99'):
            raise ValidationError(
                '–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å 99.99 –∫–º.'
            )


# 1. –§–æ—Ä–º–∞ –¥–ª—è –û–±—â–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–®–∞–≥ 1)
class RouteInfoForm(FlaskForm):
    route_name = StringField('–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞', validators=[DataRequired(), Length(max=30)])
    
    carrier_id = StringField('ID –ü–µ—Ä–µ–≤–æ–∑—á–∏–∫–∞ (–Ω–∞–ø—Ä., 7012)', validators=[DataRequired(), Length(min=1, max=10), Regexp(r'^\d+$', message='ID –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã.')])
    unit_id = StringField('ID –ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è (–Ω–∞–ø—Ä., 0001)', validators=[DataRequired(), Length(min=1, max=10), Regexp(r'^\d+$', message='ID –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã.')])
    route_number = StringField('–ù–æ–º–µ—Ä –º–∞—Ä—à—Ä—É—Ç–∞ (–Ω–∞–ø—Ä., 854)', validators=[DataRequired(), Length(min=1, max=10), Regexp(r'^\d+$', message='–ù–æ–º–µ—Ä –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã.')])
    region_code = StringField('–ö–æ–¥ —Ä–µ–≥–∏–æ–Ω–∞ (–Ω–∞–ø—Ä., 66)', validators=[DataRequired(), Length(min=1, max=5), Regexp(r'^\d+$', message='–ö–æ–¥ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã.')])
    
    # –ü–æ–ª–µ –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π (–æ–±—ã—á–Ω–æ 2)
    decimal_places = SelectField('–ö–æ–ª-–≤–æ –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π (–¥–ª—è —Ü–µ–Ω)', choices=[('0', '0'), ('1', '1'), ('2', '2')], validators=[DataRequired()])
    
    transport_type = SelectField('–¢–∏–ø —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞', choices=[
        ('0x01', '–ú–µ—Ç—Ä–æ–ø–æ–ª–∏—Ç–µ–Ω (01)'),
        ('0x02', '–ê–≤—Ç–æ–±—É—Å (–≥–æ—Ä–æ–¥—Å–∫–æ–π) (02)'), # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è 02 –≤ —Ñ–∞–π–ª–µ
        ('0x20', '–ê–≤—Ç–æ–±—É—Å (–ø—Ä–∏–≥–æ—Ä–æ–¥–Ω—ã–π) (20)'),
        ('0x40', '–ê–≤—Ç–æ–±—É—Å (–º–µ–∂–¥—É–≥–æ—Ä–æ–¥–Ω–∏–π) (40)'),
        ('0x04', '–¢—Ä–æ–ª–ª–µ–π–±—É—Å (04)'),
        ('0x08', '–¢—Ä–∞–º–≤–∞–π (08)'),
        ('0x10', '–ú–∞—Ä—à—Ä—É—Ç–Ω–æ–µ —Ç–∞–∫—Å–∏ (10)'),
        ('0x80', '–ü–æ–µ–∑–¥ (–ø—Ä–∏–≥–æ—Ä–æ–¥–Ω—ã–π) (80)'),
    ], validators=[DataRequired()])
    
    # –¢–µ–ø–µ—Ä—å —ç—Ç–æ –¢–∞—Ä–∏—Ñ–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã (FieldList)
    tariff_tables = FieldList(
        FormField(TariffTableEntryForm), 
        min_entries=1, 
        max_entries=15, # <-- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ 15 —Ç–∞–±–ª–∏—Ü
        label='–¢–∞—Ä–∏—Ñ–Ω—ã–µ –¢–∞–±–ª–∏—Ü—ã (TabN)'
    )
    
    next_step = SubmitField('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø–µ—Ä–µ–π—Ç–∏ –∫ —Å–ø–∏—Å–∫—É –æ—Å—Ç–∞–Ω–æ–≤–æ–∫')


    def validate_tariff_tables(self, field):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ–±–ª—é–¥–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–ª—è —Ç–∞—Ä–∏—Ñ–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü (Tabs)."""
        
        all_ss_codes = set()
        
        for i, entry in enumerate(field.entries):
            form_data = entry.form
            
            # –ü–∞—Ä—Å–∏–º —Å—Ç—Ä–æ–∫—É —Å–µ—Ä–∏–π SS
            ss_codes = [c.strip() for c in form_data.ss_series_codes.data.split(';') if c.strip()]

            # 1. –ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è –¢–∞–±–ª–∏—Ü—ã 1 (i == 0)
            if i == 0:
                if form_data.table_type_code.data != '02':
                    raise ValidationError('–¢–∞–±–ª–∏—Ü–∞ 1 –¥–æ–ª–∂–Ω–∞ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å –∫–æ–¥–∞ "02".')
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–∏–π SS –Ω–µ –ø—É—Å—Ç, —Ç.–∫. "02" —É–∂–µ –±—ã–ª –≤ TableTypeCode
                if not ss_codes:
                    raise ValidationError('–¢–∞–±–ª–∏—Ü–∞ 1 –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å–µ—Ä–∏–∏ SS –ø–æ—Å–ª–µ "02".')
            
            # 2. –ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è –¢–∞–±–ª–∏—Ü > 1 (i > 0)
            else:
                if form_data.table_type_code.data not in ['P', 'T', 'F']:
                    raise ValidationError(f'–¢–∞–±–ª–∏—Ü–∞ {i+1} –¥–æ–ª–∂–Ω–∞ –∏–º–µ—Ç—å —Ç–∏–ø "P", "T" –∏–ª–∏ "F".')
            
            # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ —Å–µ—Ä–∏–π SS
            # –í–∞–∂–Ω–æ: –í —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∫–æ–¥ '02' –∏–¥–µ—Ç –ü–ï–†–í–´–ú –∑–Ω–∞—á–µ–Ω–∏–µ–º SS –≤ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–µ.
            # –ï—Å–ª–∏ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –∫–∞–∫ table_type_code, –º—ã –Ω–µ –¥–æ–ª–∂–Ω—ã –ø—Ä–æ–≤–µ—Ä—è—Ç—å –µ–≥–æ –∑–¥–µ—Å—å.
            # –ù–æ –µ—Å–ª–∏ table_type_code —ç—Ç–æ P/T/F, —Ç–æ P/T/F –Ω–µ –≤—Ö–æ–¥–∏—Ç –≤ ss_codes.
            
            # –ú—ã —Å–æ–±–∏—Ä–∞–µ–º –∫–æ–¥—ã SS –∏–∑ –ø–æ–ª–µ–π "ss_series_codes" –¥–ª—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü:
            for code in ss_codes:
                if code in all_ss_codes:
                    # –£–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç –≤–æ–∑–Ω–∏–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ i+1
                    raise ValidationError(
                        f'–°–µ—Ä–∏—è SS "{code}" –≤ –¢–∞–±–ª–∏—Ü–µ {i+1} —É–∂–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –¥—Ä—É–≥–æ–π —Ç–∞–±–ª–∏—Ü–µ. '
                        '–û–¥–∏–Ω –Ω–æ–º–µ—Ä —Å–µ—Ä–∏–∏ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ –±–ª–æ–∫–∞ Tabs.'
                    )
                all_ss_codes.add(code)
                
            # 4. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –ï—Å–ª–∏ –∫–æ–¥ = 02, –µ–≥–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ –¥—Ä—É–≥–∏—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö
            # –≠—Ç–æ—Ç –∫–æ–¥ –Ω–µ –Ω—É–∂–µ–Ω, –µ—Å–ª–∏ –º—ã —É–∂–µ –ø—Ä–æ–≤–µ—Ä–∏–ª–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –≤—Å–µ—Ö ss_codes.


# 2. –§–æ—Ä–º–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –û—Å—Ç–∞–Ω–æ–≤–∫–∞–º–∏ (–û—Ç—Ä–µ–∑–∫–∞–º–∏) (–®–∞–≥ 2)
class RouteStopsForm(FlaskForm):
    # –°–ø–∏—Å–æ–∫ –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è –æ—Å—Ç–∞–Ω–æ–≤–æ–∫
    stops = FieldList(FormField(StopForm), min_entries=2, label='–û—Å—Ç–∞–Ω–æ–≤–∫–∏')

    # save_and_continue = SubmitField('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø–µ—Ä–µ–π—Ç–∏ –∫ —Ü–µ–Ω–∞–º')
    add_stop = SubmitField('–î–æ–±–∞–≤–∏—Ç—å –æ—Å—Ç–∞–Ω–æ–≤–∫—É') # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ –¥–ª—è JS
    # üí• –ù–£–ñ–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–æ–±–∞–≤—å—Ç–µ SubmitField –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É
    next_step = SubmitField('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏ –ø–µ—Ä–µ–π—Ç–∏ –∫ —Ü–µ–Ω–∞–º (–®–∞–≥ 3)')
    

    def validate_stops(self, field):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –≤ –∫–∏–ª–æ–º–µ—Ç—Ä–∞—Ö (km_distance) —Å—Ç—Ä–æ–≥–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–µ—Ç."""
        
        # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫
        if len(field.entries) < 2:
            raise ValidationError('–ú–∞—Ä—à—Ä—É—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (–Ω–∞—á–∞–ª—å–Ω—É—é –∏ –∫–æ–Ω–µ—á–Ω—É—é).')

        previous_km = Decimal('-1.0') # –ù–∞—á–∏–Ω–∞–µ–º —Å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–≥–æ —á–∏—Å–ª–∞ –¥–ª—è –ø–µ—Ä–≤–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
        
        for i, entry in enumerate(field.entries):
            # entry.form - —ç—Ç–æ —ç–∫–∑–µ–º–ø–ª—è—Ä StopForm, entry.data - —Å–ª–æ–≤–∞—Ä—å –¥–∞–Ω–Ω—ã—Ö
            
            # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ FieldList.km_distance (–æ–±—ä–µ–∫—Ç Decimal)
            current_km_decimal = entry.form.km_distance.data
            
            # –ï—Å–ª–∏ DecimalField –Ω–µ —Å–º–æ–≥ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤–≤–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ —á–∏—Å–ª–æ), 
            # –Ω–æ InputRequired –ø—Ä–æ—à–µ–ª, —Ç–æ —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å None. –ù–æ NumberRange —É–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç >= 0.
            # –ï—Å–ª–∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è DecimalField –ø—Ä–æ—à–ª–∞, current_km_decimal –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ >= 0.
            
            # –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ None, —Ö–æ—Ç—è InputRequired –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å —ç—Ç–æ
            if current_km_decimal is None:
                raise ValidationError(f'–û—à–∏–±–∫–∞: –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ ‚Ññ{i} –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ.')

            # 2. –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è –ø–µ—Ä–≤–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (index == 0)
            if i == 0:
                if current_km_decimal != Decimal('0.00'):
                    raise ValidationError('–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –Ω–∞—á–∞–ª—å–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (–û—Å—Ç–∞–Ω–æ–≤–∫–∞ 0) –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 0.00 –∫–º.')
                
            # 3. –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –æ—Å—Ç–∞–Ω–æ–≤–æ–∫ (index > 0)
            if current_km_decimal <= previous_km:
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º data –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–º–µ–Ω–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
                stop_name = entry.form.stop_name.data or f'#{i}' 
                
                # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º Decimal –¥–ª—è –≤—ã–≤–æ–¥–∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏
                prev_km_str = f"{previous_km:.2f}"
                curr_km_str = f"{current_km_decimal:.2f}"
                
                raise ValidationError(
                    f'–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ "{stop_name}" ({curr_km_str} –∫–º) –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å '
                    f'—Å—Ç—Ä–æ–≥–æ –±–æ–ª—å—à–µ ({prev_km_str} –∫–º) –ø—Ä–µ–¥—ã–¥—É—â–µ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏.'
                )
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ
            previous_km = current_km_decimal


# 3. –§–æ—Ä–º–∞ –¥–ª—è –≤–≤–æ–¥–∞ –¶–µ–Ω (–ú–∞—Ç—Ä–∏—Ü–∞) (–®–∞–≥ 3)
# –≠—Ç–∞ —Ñ–æ—Ä–º–∞ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ ID –º–∞—Ä—à—Ä—É—Ç–∞ –∏ –ø–æ–ª—É—á–µ–Ω–∏—è 
# –≤—Å–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –º–∞—Ç—Ä–∏—Ü—ã —Ü–µ–Ω, —Å–æ–±—Ä–∞–Ω–Ω–æ–π —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º –≤ JSON-—Ñ–æ—Ä–º–∞—Ç–µ.
class RoutePricesForm(FlaskForm):
    # –í —ç—Ç–æ–º —Å–∫—Ä—ã—Ç–æ–º –ø–æ–ª–µ –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å—Å—è –≤—Å—è –º–∞—Ç—Ä–∏—Ü–∞ —Ü–µ–Ω –≤ –≤–∏–¥–µ JSON-—Å—Ç—Ä–æ–∫–∏.
    # –§—Ä–æ–Ω—Ç–µ–Ω–¥ (JavaScript) –±—É–¥–µ—Ç –æ—Ç–≤–µ—á–∞—Ç—å –∑–∞ –µ–µ —Å–±–æ—Ä –∏ –ø–æ–º–µ—â–µ–Ω–∏–µ —Å—é–¥–∞.
    # –ï—Å–ª–∏ –ø–æ–ª–µ –±—É–¥–µ—Ç –ø—É—Å—Ç—ã–º, —ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —Ü–µ–Ω—ã –Ω–µ –±—ã–ª–∏ –≤–≤–µ–¥–µ–Ω—ã.
    # price_matrix_data = HiddenField('–î–∞–Ω–Ω—ã–µ –º–∞—Ç—Ä–∏—Ü—ã —Ü–µ–Ω', validators=[DataRequired()])
    price_matrix_data = HiddenField('–î–∞–Ω–Ω—ã–µ –º–∞—Ç—Ä–∏—Ü—ã —Ü–µ–Ω')
    
    # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö
    save_prices = SubmitField('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ —Ü–µ–Ω—ã')
